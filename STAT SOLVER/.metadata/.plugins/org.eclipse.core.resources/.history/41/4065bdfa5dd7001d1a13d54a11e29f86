package edu.uno.ai.sat.ex;

import java.util.*;

import edu.uno.ai.logic.Formula;
import edu.uno.ai.sat.*;
import edu.uno.ai.util.ImmutableArray;

/**
 * 
 * @author 
 */
public class Smosely extends Solver {

	//private final Random random = new Random(0);
	//private int maxOperations;
    private long startTime;
	//private Formula formula;
	
	/**
	 * Constructs a new random SAT solver. You should change the string below
	 * from "random" to your ID. You should also change the name of this class.
	 * In Eclipse, you can do that easily by right-clicking on this file
	 * (RandomAgent.java) in the Package Explorer and choosing Refactor > Rename.
	 */
	public Smosely() {
		super("My Solver");
		//this.maxOperations = 1000000;
        this.startTime = System.currentTimeMillis();
	}


	@Override
    public boolean solve(Assignment assignment) {
		
		return resolve(assignment, (List<Variable>) assignment.problem.variables);
    }
	
	
	private boolean resolve(Assignment assignment, List<Variable> variables) {
		// TODO Auto-generated method stub
		if(variables.isEmpty()){
			return assignment.getValue() == Value.TRUE;
		}
		
		Variable variable = null;
		int minValueCount = Integer.MAX_VALUE;
		for(Variable var : variables) {
			if(assignment.getValue(var) == Value.UNKNOWN) {
				int valueCount = getValueCount(var);
				
				if(valueCount < minValueCount) {
					minValueCount = valueCount;
					variable = var;
				}
			}
		}
		
		if(variable == null){
			return assignment.getValue() == Value.TRUE;
		}
		
		assignment.setValue(variable, Value.TRUE);
		
		if(resolve(assignment, variables)) {
			return true;
		}
		
		assignment.setValue(variable, Value.FALSE);
		
		if(resolve(assignment, variables)) {
			return true;
		}
		
		assignment.setValue(variable, Value.UNKNOWN);
		return false;
	}


	
	private final Variable chooseVariable(Assignment assignment) {
		ArrayList<Variable> unassign = new ArrayList<Variable>();

		int maxOccurrence = -1;
		
		for(Variable variable : assignment.problem.variables) {
			if(assignment.getValue(variable) == Value.UNKNOWN) {
				
				int occurrence = countOccurrences(assignment, variable);
				
				if(occurrence > maxOccurrence) {
					
					maxOccurrence = occurrence;
					unassign.clear();
				}
				
				if(occurrence == maxOccurrence) {
					unassign.add(variable);
				}
			}
		}
		
		return unassign.get(random.nextInt(unassign.size()));
	}
	
	private int countOccurrences(Assignment assignment, Variable variable) {
		
		int count = 0;
		
		for(int i = 0; i < assignment.problem.clauses.size(); i++) {
			if(assignment.problem.clauses.get(i).contains(variable)) {
				count++;
			}
		}
		return count;
	}
}
